kind: "BuildConfig"
apiVersion: "v1"
metadata:
  name: "auth-service-pipeline"
spec:
  strategy:
    jenkinsPipelineStrategy:
      jenkinsfile: |-
        pipeline {
          stages {
            stage 'Clone the project'
            git 'http://gogs-cicd.192.168.99.100.nip.io/akkarawu/auth_service.git'

            dir('spring-jenkins-pipeline') {
                stage("Compilation and Analysis") {
                    parallel 'Compilation': {
                        sh "./mvnw clean install -DskipTests"
                    }, 'Static Analysis': {
                        stage("Checkstyle") {
                            sh "./mvnw checkstyle:checkstyle"

                            step([$class: 'CheckStylePublisher',
                              canRunOnFailed: true,
                              defaultEncoding: '',
                              healthy: '100',
                              pattern: '**/target/checkstyle-result.xml',
                              unHealthy: '90',
                              useStableBuildAsReference: true
                            ])
                        }
                    }
                }

                stage("Tests and Deployment") {
                    parallel 'Unit tests': {
                        stage("Runing unit tests") {
                            try {
                                sh "./mvnw test -Punit"
                            } catch(err) {
                                step([$class: 'JUnitResultArchiver', testResults:
                                  '**/target/surefire-reports/TEST-*UnitTest.xml'])
                                throw err
                            }
                           step([$class: 'JUnitResultArchiver', testResults:
                             '**/target/surefire-reports/TEST-*UnitTest.xml'])
                        }
                    }, 'Integration tests': {
                        stage("Runing integration tests") {
                            try {
                                sh "./mvnw test -Pintegration"
                            } catch(err) {
                                step([$class: 'JUnitResultArchiver', testResults:
                                  '**/target/surefire-reports/TEST-'
                                    + '*IntegrationTest.xml'])
                                throw err
                            }
                            step([$class: 'JUnitResultArchiver', testResults:
                              '**/target/surefire-reports/TEST-'
                                + '*IntegrationTest.xml'])
                        }
                    }

                    stage("Staging") {
                        sh "pid=\$(lsof -i:8989 -t); kill -TERM \$pid "
                          + "|| kill -KILL \$pid"
                        withEnv(['JENKINS_NODE_COOKIE=dontkill']) {
                            sh 'nohup ./mvnw spring-boot:run -Dserver.port=8989 &'
                        }
                    }
                }
            }
          }
        } // pipeline
      type: JenkinsPipeline
